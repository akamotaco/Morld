# 시나리오04 - 숲속 저택 생활 시뮬레이션

## 기본 정보

| 항목 | 내용 |
|------|------|
| **배경** | 근현대 (전기/가스 없는 자급자족 생활) |
| **장르** | 생활 + 연애 시뮬레이션 |
| **시놉시스** | 기억을 잃은 남자가 숲속을 헤매다 저택에서 쓰러지고, 그곳에 사는 여성들에게 구조되어 함께 생활하게 된다 |

---

## 게임 진행 단계 (로드맵)

```
[Phase 1: 신입]
- 플레이어 = 최하위, 잡일 담당
- 리더(엘라)가 매일 업무 지시
- 여자들 눈치 보며 생활
- 호감도 쌓기 시작

[Phase 2: 인정]
- 신뢰도 상승 → 자율 행동 범위 확대
- 특정 캐릭터와 비밀 연애 시작
- 다른 눈 피해 몰래 만남

[Phase 3: 핵심 인물]
- 조회 시간에 업무 지시 가능
- 채집/사냥 파티 편성
- 저택 운영 의사결정 참여

[Phase 4: 서바이벌] (향후)
- 외부 위협 등장
- 자원 관리, 방어 전략
- 생존 시스템 본격화
```

---

## 게임 흐름

```
[게임 시작]
    ↓
[1. 캐릭터 설정]
  - 숲에서 의식이 희미하게 깨어남
  - 이름 / 나이 / 신체 / 초기 장비 선택
    ↓
[2. 숲에서 방황]
  - 플레이어 조작 가능
  - 시작 위치: 숲 깊은 곳 (Region 1, Location 1)
  - 목표: 저택 앞마당 도착
    ↓
[3. 앞마당 도착 - 쓰러짐]
  - 저택을 발견하고 쓰러짐
  - 시간 경과 (3시간)
    ↓
[4. 주인공 방에서 깨어남]
  - 저택 주인공 방 (Region 0, Location 6)
  - 누군가 구해주었음을 알게 됨
    ↓
[5. 첫 만남 이벤트]
  - NPC와 처음 만났을 때 자기소개
  - can_first_meet 플래그로 제어
    ↓
[6. 본격적인 게임 시작]
  - 자유 행동
  - 저택 생활 시작
```

---

## 지도 구성

### Region 0: 저택

**1층:**
| ID | 이름 | 설명 | 가구 |
|----|------|------|------|
| 0 | 현관 | 저택 입구 | - |
| 1 | 거실 | 공용 공간, 조회 장소, 계단 있음 | 벽난로, 낡은 소파, 책장 |
| 2 | 주방 | 요리 담당 활동 | 아궁이, 찬장 |
| 3 | 식당 | 식사 장소 | 긴 식탁 |
| 4 | 욕실 | | 나무 욕조, 세면대 |
| 5 | 창고 | 물자 보관 | 선반 |
| 6 | 주인공 방 | 플레이어 개인 공간 (1층) | 침대, 작은 책상, 거울 |
| 7 | 리나 방 | (1층) | - |
| 9 | 밀라 방 | (1층) | - |
| 12 | 앞마당 | 저택 정문 앞, 숲과 연결 | 정원 벤치, 우물 |
| 13 | 뒷마당 | 저택 뒤편, 텃밭 | 텃밭, 빨래 건조대 |

**2층:**
| ID | 이름 | 설명 | 가구 |
|----|------|------|------|
| 14 | 2층 복도 | 계단 올라오면 나오는 복도 | 복도 창문, 화병 |
| 8 | 세라 방 | (2층) | - |
| 10 | 유키 방 | (2층) | - |
| 11 | 엘라 방 | (2층) | - |

### Region 1: 야외

| ID | 이름 | 설명 | 획득 가능 아이템 |
|----|------|------|-----------------|
| 0 | 숲 입구 | 앞마당과 연결 | - |
| 1 | 숲 깊은 곳 | 플레이어 시작 위치 | 약초, 나무 |
| 2 | 강가 | 물 획득 | 물 |
| 3 | 채집터 | 안전한 채집 | 밀가루, 쌀, 열매 |
| 4 | 사냥터 | 사냥 장소 | 고기 |

### 지역 연결

- 앞마당(0:12) ↔ 숲 입구(1:0): 이동시간 3분

---

## 등장인물

### 플레이어 (ID: 0)

```python
{
    "name": "???",  # 게임 시작 시 선택
    "tags": {
        # 기본 스탯 (1~10)
        "힘": 5,
        "지능": 5,
        "손재주": 5,
        "체력": 5,

        # 신체 (택1: 왜소/보통/장신/거구)
        "신체:보통": 1,

        # 나이
        "나이": 22,

        # 그룹 내 지위
        "신뢰도": 0,
    }
}
```

### 여성 캐릭터 (5명)

| ID | 이름 | 역할 | 성격 태그 | 외모 태그 |
|----|------|------|----------|----------|
| 1 | 리나 | 채집 담당 | 명랑함, 활발함 | 금발, 단발, 녹색눈 |
| 2 | 세라 | 사냥 담당 | 과묵함, 듬직함 | 흑발, 장발, 갈색눈 |
| 3 | 밀라 | 요리 담당 | 다정함, 걱정많음 | 갈색머리, 중간머리, 갈색눈 |
| 4 | 유키 | 청소/빨래 | 수줍음, 얌전함 | 은발, 장발, 붉은눈 |
| 5 | 엘라 | 저택 관리자 | 냉정함, 리더십 | 흑발, 올림머리, 보라색눈 |

### NPC 태그 구조

```python
{
    # 외모 (고정)
    "외모:금발": 1,
    "외모:단발": 1,
    "외모:녹색눈": 1,

    # 성격 (고정)
    "성격:명랑함": 1,
    "성격:활발함": 1,

    # 관계 (가변) - 플레이어와의 관계
    "애정": 0,      # 0~10, 호감도
    "성욕": 0,      # 0~10, 스킨십 욕구
    "질투": 0,      # 0~10, 다른 여성과 있을 때 반응

    # 상태 (가변)
    "피로": 0,
    "기분": 5,
}
```

---

## 태그 기반 통합 시스템

모든 수치를 Unit의 tags로 관리:

- **외모 태그**: `외모:금발`, `외모:장발` 등 (고정)
- **성격 태그**: `성격:명랑함`, `성격:수줍음` 등 (고정)
- **관계 태그**: `애정`, `성욕`, `질투` (가변, 0~10)
- **스탯 태그**: `힘`, `지능`, `손재주`, `체력` (가변)
- **신체 태그**: `신체:왜소`, `신체:보통`, `신체:장신`, `신체:거구` (택1)
- **지위 태그**: `신뢰도` (0~10)

---

## 애정행각 시스템

### 해금 조건 (애정 태그 기준)

| 애정 수치 | 해금 행동 |
|----------|----------|
| 0~2 | 대화만 |
| 3~4 | 머리 쓰다듬기 |
| 5~6 | 볼 당기기 |
| 7~8 | 껴안기 |
| 9~10 | 키스 |

### 실행 조건

- 해당 장소에 **둘만** 있어야 함
- 제3자 도착 시 **즉시 중단** + 이벤트 발생

### 제3자 목격 시

- 목격자 `질투` 상승
- 목격자 성격에 따라 반응:
  - 냉정한 엘라: "...실례했군." (차갑게)
  - 명랑한 리나: "어?! 뭐야뭐야~?" (놀리며)
  - 수줍은 유키: "...!" (도망감)

### (향후) NPC 능동 행동

- 높은 `성욕` + 높은 `애정` → NPC가 먼저 스킨십 시도
- 높은 `질투` + 다른 여성과 목격 → 치정 이벤트

---

## 감정 표현 시스템 (PRESENCE_TEXT)

호감도 + 성격 조합으로 다양한 반응:

### 수줍은 캐릭터 (유키) 예시

```python
PRESENCE_TEXT = {
    "애정:낮음": "{name}가 멀찍이 서서 이쪽을 힐끗 본다.",
    "애정:중간": "{name}가 자꾸 플레이어 쪽을 흘깃흘깃 쳐다본다.",
    "애정:높음": "{name}와 눈이 마주치자 얼굴을 붉히며 눈을 피한다.",
    "애정:최고": "{name}가 수줍게 웃으며 옆에 다가와 선다.",
}
```

### 명랑한 캐릭터 (리나) 예시

```python
PRESENCE_TEXT = {
    "애정:낮음": "{name}가 씩씩하게 인사한다.",
    "애정:중간": "{name}가 반갑게 손을 흔든다.",
    "애정:높음": "{name}가 환하게 웃으며 다가온다.",
    "애정:최고": "{name}가 자연스럽게 옆에 딱 붙어 선다.",
}
```

---

## 신뢰도 시스템 (그룹 내 지위)

### 신뢰도 단계

| 신뢰도 | 단계 | 권한 |
|--------|------|------|
| 0~2 | 신입 | 리더 지시 따르기만 |
| 3~5 | 일원 | 자유 행동, 개인 채집 |
| 6~8 | 핵심 | 조회에서 의견 제시 |
| 9~10 | 리더급 | 업무 지시, 파티 편성 |

### 신뢰도 상승 조건

- 지시받은 일 완수
- 채집/사냥 성과
- 위기 상황 대처
- 호감도 높은 캐릭터의 지지

---

## 아이템

| ID | 이름 | 획득처 | 용도 (향후) |
|----|------|--------|------------|
| 0 | 밀가루 | 채집터 | 빵 재료 |
| 1 | 쌀 | 채집터 | 밥 재료 |
| 2 | 물 | 강가 | 요리, 음료 |
| 3 | 빵 | 조합 | 식량 |
| 4 | 나무 | 숲 깊은 곳 | 건축, 연료 |
| 5 | 열매 | 채집터 | 식량 |
| 6 | 약초 | 숲 깊은 곳 | 치료 |
| 7 | 고기 | 사냥터 | 식량 |

---

## 날씨 시스템

| 날씨 | 실외 효과 | appearance 태그 |
|------|----------|-----------------|
| 맑음 | 정상 | `날씨:맑음` |
| 흐림 | 정상 | `날씨:흐림` |
| 비 | 이동시간 +50% | `날씨:비` |
| 눈 | 일부 장소 접근 불가 | `날씨:눈` |

---

## 플레이어 캐릭터 생성

### 이름 선택지

- 카이
- 레온
- 아론
- 유진

### 나이 선택지

| 나이 | 설명 |
|------|------|
| 17세 | 아직 어린 소년 |
| 22세 | 청년 (기본) |
| 30세 | 성숙한 장년 |

### 신체 선택지

| 타입 | 태그 | 효과 (향후) |
|------|------|------------|
| 왜소 | `신체:왜소` | 은신↑, 힘↓, 좁은 곳 통과 |
| 보통 | `신체:보통` | 균형 |
| 장신 | `신체:장신` | 위압감↑, 높은 곳 도달 |
| 거구 | `신체:거구` | 힘↑, 체력↑, 민첩↓ |

### 스탯

| 스탯 | 설명 | 영향 (향후) |
|------|------|------------|
| 힘 | 물리적 힘 | 사냥 성공률, 무거운 물건 운반, 전투 |
| 지능 | 지적 능력 | 크래프팅 성공률, 대화 선택지, 문제 해결 |
| 손재주 | 손 기술 | 채집 효율, 정밀 작업, 함정 설치 |
| 체력 | 지구력 | 야외 활동 지속시간, 피로 저항 |

### 초기 장비 선택지

| 선택 | 장비 | 컨셉 |
|------|------|------|
| A | 낡은 칼, 가죽 주머니 | 전직 사냥꾼 |
| B | 필기구, 책 한 권 | 학자/서기 |
| C | 작은 도구함 | 장인/기술자 |
| D | 아무것도 없음 | 완전 빈손 |

---

## 구현 우선순위

### 1단계 - 기본 (현재)

- [x] 폴더 구조 생성
- [x] 지도 (저택 15개 방 + 야외 5개 장소, 2층 구조)
- [x] 캐릭터 6명 (플레이어 + 여성 5명)
- [x] 기본 스케줄
- [x] 게임 시작 인트로 + 캐릭터 생성
- [x] 기본 아이템 정의
- [x] 게임 흐름 (숲→앞마당→쓰러짐→방→첫만남)
- [x] 가구 오브젝트 18개 (상호작용 가능)
- [ ] 대화 시스템 (호감도 태그 기반)

### 2단계 - 연애

- [ ] 애정행각 시스템
- [ ] 둘만 있을 때 체크
- [ ] 호감도별 PRESENCE_TEXT
- [ ] 제3자 등장 이벤트

### 3단계 - 생활

- [ ] 채집/아이템 획득
- [ ] 날씨 시스템
- [ ] 신뢰도 시스템
- [ ] 조회/업무 지시

### 4단계 - 서바이벌 (향후)

- [ ] 생존 게이지 (배고픔, 피로 등)
- [ ] 크래프팅
- [ ] 외부 위협
- [ ] 전술 요소

---

## 챕터 시스템

플래그 기반으로 게임 진행 단계를 관리한다.

### 챕터 정의

| 챕터 | 플래그 | 설명 |
|------|--------|------|
| 0 | `chapter = 0` | 프롤로그 - 캐릭터 생성, 숲 방황, NPC 이벤트 없음 |
| 1 | `chapter = 1` | 메인 게임 - 저택 생활, NPC 스케줄 활성화 |
| 2+ | `chapter = 2+` | 향후 확장 |

### 챕터별 동작

**챕터 0 (프롤로그):**
- `can_first_meet = 0` → NPC 첫만남 이벤트 없음
- NPC는 존재하지만 이벤트만 비활성화
- 앞마당 도착 시 챕터 1로 전환

**챕터 1 (메인):**
- `can_first_meet = 1` → NPC 첫만남 이벤트 활성화
- 모든 시스템 정상 동작

### 챕터 전환 시점

```
[챕터 0 시작] game_start
    ↓
[캐릭터 생성] set_name → set_age → set_body → set_equipment
    ↓
[숲 방황] 플레이어 자유 이동
    ↓
[앞마당 도착] on_reach_front_yard → 쓰러짐
    ↓
[챕터 1 전환] after_collapse → chapter=1, can_first_meet=1
    ↓
[방에서 깨어남] 본격 게임 시작
```

---

## 세이브/로드 시스템 (향후)

### 현재 저장 가능한 데이터 (C#)

| 시스템 | 파일 | 상태 |
|--------|------|------|
| UnitSystem | unit_data.json | ✅ 저장/로드 가능 |
| ItemSystem | item_data.json | ✅ 저장/로드 가능 |
| PlayerSystem | player_data.json | ✅ 저장/로드 가능 |
| InventorySystem | inventory_data.json | ✅ 로드 가능 |
| 플래그 (set_flag) | unit_data.json (tags) | ✅ 플레이어 태그에 저장 |

### Python에만 있는 데이터 (저장 불가)

| 데이터 | 위치 | 문제 |
|--------|------|------|
| `_flags` | 각 NPC events.py | ❌ first_meet 등 저장 안 됨 |
| `_triggered_events` | events.py | ❌ 발생한 이벤트 기록 저장 안 됨 |
| `_creation_data` | player/events.py | ❌ 플레이어 이름(문자열) 저장 안 됨 |

### 해결 방안 (향후 구현)

1. **Python 상태 → C# 플래그 이관**
   - `first_meet_lina`, `first_meet_sera` 등 개별 플래그로 관리
   - 문자열은 인덱스로 변환하여 저장

2. **Python 상태 별도 저장 API**
   ```python
   morld.save_python_state("scenario_state.json")
   morld.load_python_state("scenario_state.json")
   ```

3. **시나리오별 초기화 함수**
   ```python
   def on_load_game():
       """세이브 로드 후 Python 상태 복원"""
       # 플래그에서 상태 읽어서 복원
   ```

---

## 시스템 확장 필요 사항

| 기능 | 현재 상태 | 필요 이유 |
|------|----------|----------|
| 텍스트 입력 | 없음 | 이름 입력 (대안: 선택지) |
| 태그 동적 수정 | `morld.set_flag()` | `morld.set_unit_tag(unit_id, tag, value)` |
| 스탯 배분 UI | 없음 | +/- 버튼 (대안: 프리셋 선택) |
| 같은 장소 유닛 체크 | 있음 | 둘만 있는지 확인 |
| 동적 PRESENCE_TEXT | 고정 키 매칭 | 태그 값 범위 기반 선택 |
| Python 상태 저장 | 없음 | 세이브/로드 시 Python 변수 보존 |
| 유닛 동적 제거 | 없음 | 챕터 전환 시 NPC 제거 (대안: 비활성화) |

---

## 저택 층별 구조

```
[2층]
┌─────────────┬─────────────┬─────────────┐
│  세라 방(8)  │ 2층 복도(14) │  유키 방(10) │
│             │   창문,화병   │             │
├─────────────┴──────┬──────┴─────────────┤
│                    │                    │
│                    │     엘라 방(11)     │
│                    │                    │
└────────────────────┴────────────────────┘
                     ↓ 계단

[1층]
┌─────────────┬─────────────┬─────────────┐
│  주인공 방(6) │   거실(1)    │  리나 방(7)  │
│ 침대,책상,거울│벽난로,소파,책장│             │
├─────────────┼─────────────┼─────────────┤
│  밀라 방(9)  │   현관(0)    │   욕실(4)   │
│             │             │ 욕조,세면대  │
├─────────────┼─────────────┼─────────────┤
│   주방(2)    │   식당(3)    │   창고(5)   │
│ 아궁이,찬장  │   긴 식탁    │    선반     │
└─────────────┴─────────────┴─────────────┘

[마당]
┌─────────────────────────────────────────┐
│              앞마당(12)                  │
│           벤치, 우물, 정원               │
│                  ↓                      │
│            숲 입구(1:0)                  │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│              뒷마당(13)                  │
│           텃밭, 빨래 건조대              │
└─────────────────────────────────────────┘
```

### 층별 캐릭터 배치

| 층 | 캐릭터 | 방 |
|----|--------|-----|
| 1층 | 주인공, 리나, 밀라 | 6, 7, 9 |
| 2층 | 세라, 유키, 엘라 | 8, 10, 11 |

### 가구 목록

| ID | 이름 | 위치 | 상호작용 |
|----|------|------|----------|
| 50 | 벽난로 | 거실 | 살펴보기 |
| 51 | 낡은 소파 | 거실 | 앉기 |
| 52 | 책장 | 거실 | 살펴보기 |
| 53 | 긴 식탁 | 식당 | 살펴보기 |
| 54 | 아궁이 | 주방 | 살펴보기 |
| 55 | 찬장 | 주방 | 살펴보기 |
| 56 | 나무 욕조 | 욕실 | 목욕하기 |
| 57 | 세면대 | 욕실 | 세수하기 |
| 58 | 선반 | 창고 | 살펴보기 |
| 59 | 침대 | 주인공 방 | 잠자기, 누워있기 |
| 60 | 작은 책상 | 주인공 방 | 살펴보기 |
| 61 | 거울 | 주인공 방 | 거울 보기 |
| 62 | 복도 창문 | 2층 복도 | 밖을 보기 |
| 63 | 화병 | 2층 복도 | 살펴보기 |
| 64 | 정원 벤치 | 앞마당 | 앉기 |
| 65 | 우물 | 앞마당 | 들여다보기, 물 길어올리기 |
| 66 | 텃밭 | 뒷마당 | 살펴보기 |
| 67 | 빨래 건조대 | 뒷마당 | 살펴보기 |

---

## NPC 상호작용 시스템 (설계 중)

NPC가 오브젝트와 자연스럽게 상호작용하는 시스템.
단순 스케줄 자동화가 아닌, NPC가 실제로 위치에 있을 때만 동작해야 함.

### 목표

- NPC가 아침에 전등을 켜고, 자기 전에 끄는 행동
- NPC가 잠을 잘 때 문을 안에서 잠그는 행동
- 플러그인 형태로 확장 가능한 구조

### 핵심 제약

1. **NPC 존재 필수**: 해당 위치에 NPC가 실제로 있을 때만 동작
2. **스케줄 자동화 아님**: 시간만 맞으면 자동 실행되는 방식 X
3. **Activity 기반 트리거**: activity 변경 시점에 행동 실행

### 문 잠금 시스템

**현재 Edge 조건 시스템:**
```csharp
// Dictionary<string, int> - 모든 조건이 AND로 체크됨
ConditionsAtoB: { "열쇠": 1, "힘": 5 }  // 열쇠 AND 힘>=5 필요
```

**한계점:**
- AND만 지원, OR 불가 ("열쇠 OR lockpick" 표현 불가)
- 동적 조건 불가 ("잠김" 상태 기반 조건 없음)

**확장 방안 (단계적):**

1단계: 동적 조건 추가/제거
```csharp
// NPC가 잠글 때
edge.AddConditionBtoA("문:세라방:잠김", 1);
// NPC가 열 때
edge.RemoveConditionBtoA("문:세라방:잠김");
```

2단계: OR 조건 지원
```csharp
// "열쇠 OR (lockpick AND 손재주>=3)"
condition.OrGroups = [
    { "열쇠:세라방": 1 },
    { "lockpick": 1, "손재주": 3 }
];
```

### Activity Behavior Hook (설계안)

```csharp
interface IActivityBehavior
{
    string ActivityName { get; }  // "수면", "식사" 등
    void OnActivityStart(Unit unit, Location location);
    void OnActivityEnd(Unit unit, Location location);
}

// 예시: 수면 행동
class SleepBehavior : IActivityBehavior
{
    public string ActivityName => "수면";

    public void OnActivityStart(Unit unit, Location location)
    {
        // 같은 위치의 문 Edge 찾아서 잠금
        var doorEdge = FindDoorEdge(unit, location);
        doorEdge?.AddCondition($"문:{unit.Name}방:잠김", 1);

        // 전등 끄기 (오브젝트 상태 변경)
        var light = FindLightAt(location);
        light?.SetState("켜짐", false);
    }

    public void OnActivityEnd(Unit unit, Location location)
    {
        // 문 열기
        var doorEdge = FindDoorEdge(unit, location);
        doorEdge?.RemoveCondition($"문:{unit.Name}방:잠김");
    }
}
```

### Python 이벤트 확장 (대안)

```python
def on_event_list(ev_list):
    for event in ev_list:
        if event[0] == "on_activity_change":
            unit_id, old_activity, new_activity, location = event[1:]
            handle_activity_change(unit_id, old_activity, new_activity, location)

def handle_activity_change(unit_id, old_activity, new_activity, location):
    if new_activity == "수면":
        # 문 잠그기
        door_edge_id = get_door_edge_at(location)
        if door_edge_id:
            morld.add_edge_condition(door_edge_id, f"문:{unit_id}:잠김", 1)
        # 전등 끄기
        light_id = get_light_at(location)
        if light_id:
            morld.set_object_state(light_id, "켜짐", False)
```

### 구현 우선순위

1. **Edge 동적 조건 API** - `morld.add_edge_condition()`, `morld.remove_edge_condition()`
2. **Activity 변경 이벤트** - `on_activity_change` 이벤트 추가
3. **오브젝트 상태 시스템** - `morld.set_object_state()`, `morld.get_object_state()`
4. **OR 조건 지원** - EdgeConditionGroup 클래스

### 향후 확장

- 전등 상태에 따른 Location appearance 변경 ("불꺼진 방은 어둡다")
- 잠긴 문 노크/대화 시스템
- NPC가 능동적으로 문 열어주기 (호감도 기반)
